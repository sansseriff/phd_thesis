## Introduction

### Origin of time walk
Over the last decade, SNSPDs have advanced rapidly to become essential components in many optical systems and technologies, owing to their high efficiency $(>90\%)$~[@99.5_Chang_2021; @reddy2020superconducting], fast reset times ($< 1~\mathrm{ns}$)~[@Vetter2016Cavity] and scalability to kilopixel arrays~[@Wollman2019]. The timing jitter of SNSPDs is also best-in-class -- values as low as 3~ps have been demonstrated in short nanowires~[@Korzh2020], and new high-efficiency designs exhibit sub-10 ps jitter~[@EsmaeilZadeh2020; @Colangelo2021].


SNSPD jitter increases with count rate due to properties of the nanowire reset process and features of the readout circuit. The effect bears resemblance to time walk observed in silicon avalanche diodes and other detectors where the pulses have varying heights and slew rates~[@SPAD_walk_Kirchnir_1997] thereby causing a timing measurement using a fixed threshold to 'walk' along the rising edge of the pulse (the labeled delay in @fig:jitterate_intro a). 
At low count rates SNSPDs exhibit very uniform pulse heights. However, at high counts rates where the inter-arrival time is on the order of the reset time of the detector, current-reset and amplifier effects lead to smaller and distorted pulses. If photon inter-arrival times are not known a priori in the intended application, the uncorrected time walk manifests as a perceived increase in jitter (@fig:jitterate_intro b). 

![**Introduction to the time walk effect** a) Diagram illustrating two major sources of correlated high count rate jitter. First, detections may occur during the reset time of a previous detection. At this time the bias current in the nanowire is below its saturated value so that a photodetection triggers an RF pulse with correspondingly lower amplitude. Second, an RF pulse may arrive in the undershoot region of a previous pulse, where the undershoot is a period of negative voltage induced by the low-frequency cutoff properties of the readout amplifier chain. (b) Measured histograms of detections from short $3~\mathrm{ps}$ mode-locked laser pulses. With lower attenuation and higher count rate, the observed timing uncertainty is greater. Inset shows where respective count rates fall on a maximum count rate (MCR) curve [@Zhang_MCR_2019]. The MCR of an SNSPD is often quoted at the $3~\mathrm{dB}$ point, where the normalized efficiency drops to $-3~\mathrm{dB}$ of its maximum value. The jitter increase due to time walk manifests as a tail in the instrument response functions (inside dashed black box) even at count rates significantly below the 3-dB point where detector efficiency has not started to drop significantly (e.g. the 1.7 Mcps data)](./figs_02/intro_jitterate_light.svg){#fig:jitterate_intro short-caption="Introduction to the time walk effect" path="02" width=70%}

The time-walk effect in SNSPDs is typically not reported, as jitter is usually measured at low count rates where the detector has ample time to reset following each detection. But as communication and quantum information applications push into higher count rates, the high count rate induced jitter becomes more relevant. LIDAR, quantum and classical optical communication, and imaging applications may all benefit from the development of new detection systems and methods that keep jitter as low as possible in this regime. 

We first consider the features of SNSPD operation and readout that cause an increase in jitter with count rate. Then we present multiple ways of mitigating or avoiding these effects, before reviewing our preferred method that relies on a calibration and correction process. 

The jitter increase observed at high rate originates from two groups of system characteristics: (i) the intrinsic reset properties of the nanowire, and (ii) properties of the amplification chain. These influence the system's jitter differently, thus it is helpful to consider them separately. Added jitter from either or both sources can emerge when an SNSPD system is operated at high count rates.

The nanowire reset process determines how the detector becomes single-photon sensitive again after a detection. When an SNSPD fires, the current flow in the nanowire momentarily drops to near zero, then recovers in an inverted exponential fashion (@fig:jitterate_intro a). An incident photon may trigger another detection before the bias current fully returns to its saturated value, producing a pulse with a lower amplitude and slew rate. A fixed threshold comparator will trigger on this lower pulse later in time than a full amplitude pulse. If uncorrected for, this time walk manifests as an increase in jitter at high count rates.

The choice of readout amplifiers may also contribute to added high count rate jitter. Pulses may be shifted in voltage and distorted if they arrive when the RF signal has not yet reached a steady zero state following the previous detection. For example, pulses may arrive within an amplifier-induced undershoot region following previous pulses. This phenomenon is illustrated in @fig:jitterate_intro a as the area below 0~mV. The duration of ringing or undershoot effects varies widely depending on the design of the readout circuit. If they last longer than the reset time of the nanowire bias current, the calibration technique may correct for the potentially complex interactions between pulse waveforms that overlap in time.

### Jitter Mitigation Methods at High Count Rates
There are various methods for correcting for increased jitter at high count rates. These include (i) the use of extra hardware that cancels out some distortions, or (ii) simple software-based data filtering that ignores distorted time-tags. We review these techniques before covering the calibration and correction approach.

Variations in pulse height are a primary component of the distortions that appear at high rates. Such variations in other systems are commonly corrected with a constant fraction discriminator (CFD) that allows for triggering at a fixed percentage of pulse height rather than at a fixed voltage. Adding a CFD to an existing setup is straightforward for a single channel, however it does require additional hardware such as multiple high-speed discriminators and a D-type flip-flop~[@Becker2005], which significantly increases the circuit complexity and power budget of a multi-channel system. In addition, CFDs are not expected to optimally correct for distortions of the pulse rising edge which may arise from the overlap of one pulse with a signal reflection or undershoot features on the falling edge of a previous pulse. Multi-channel time-to-digital converters (TDCs) used to read out large SNSPD arrays typically only include fixed-threshold comparators~[@Wollman2019].

In a simple software-based jitter mitigation method, each time-tagged event may be accepted or rejected based on how soon it arrives after the previous pulse. Those that arrive within some pre-determined dead time are assumed to be corrupted by pulse distortions. These are rejected, and the rest are accepted. This method can lower system jitter and maintain high data rates, especially in the cases where only a few percent of pulses are filtered out. However, it can severely limit count rate near the $3~\mathrm{dB}$ point where the majority of counts are rejected (see the supplementary material).

Our correction method preserves original count rate and works with timing measurements from a fixed-threshold free-running TDC -- the type that is often used for SNSPD readout. Pulse pileup correction techniques have been demonstrated with systems that fully digitize detector pulse waveforms~[@Behbahani2019; @scoullar_evans_2009; @Haselman2010]. But capturing the fast rising edges of SNSPD pulses in this way would require very high sample rates and subsequently, impractically large data streams. In contrast, our method assumes one timing measurement is acquired from triggering on the rising edge of each SNSPD pulse. 

We calculate the time between a given *current* SNSPD detection event and a preceding event. This inter-arrival time is used to determine a timing correction for the current event using a lookup table. A calibration routine described next is needed to build this lookup table. Applying these corrections during real-time processing removes deterministic delays correlated with the time between time-tags, leaving only stochastic jitter. 



